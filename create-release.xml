<?xml version="1.0" encoding="UTF-8"?>

<!-- 
To create a release, a directory named "release" must be created in
the root directory of the project and the following files must be downloaded
from the wiki and included:
* config_editor.xml
* config_engine.xml
* eAdventure-editor.sh
* eAdventure-engine.sh
* Run eAdventure editor.bat
* Run eAdventure engine.bat

Any documentation, example games, readme-files, etc. and be added manually
to the generated zip file.
-->

<project basedir="." default="" name="build.eAdventureApplet">
	<description>
    This ant build file is used to build the project as a jar file.
	</description>

	<property name="lib.dir" value="jars" />
	<property name="gui.dir" value="gui" />
	<property name="img.dir" value="img" />
	<property name="web.dir" value="web" />
	<property name="lanengine.dir" value="i18n/engine" />
	<property name="laneditor.dir" value="i18n/editor" />
	<property name="release.version" value="0.9" />

	<path id="project.class.path">
		<fileset dir="${lib.dir}">
			<include name="*.jar" />
		</fileset>
	</path>

	<target name="complie">
		<javac srcdir="./src/" destdir="release/">
			<classpath refid="project.class.path" />
		</javac>
	</target>

	<pathconvert property="lib.project.manifest.classpath" pathsep=" ">
		<path refid="project.class.path" />
		<map from="${basedir}\${lib.dir}\" to="jars/" />
	</pathconvert>

	<target name="jar-engine" description="generate the engine jar" depends="complie">
		<delete file="release/eadventure/eadventure-engine.jar" />
		<jar compress="true" destfile="release/eadventure/eadventure-engine.jar">
			<fileset dir="release/">
				<include name="es/eucm/eadventure/engine/*.class" />
				<include name="es/eucm/eadventure/engine/**/*.class" />
			</fileset>

			<manifest>
				<attribute name="Main-Class" value="es.eucm.eadventure.engine.EAdventure" />
				<attribute name="Class-Path" value="${lib.project.manifest.classpath} jars/eadventure-common.jar jars/eadventure-comm.jar" />
			</manifest>
		</jar>
	</target>

	<target name="jar-editor" description="generate the editor jar" depends="complie">
		<delete file="release/eadventure/eadventure-editor.jar" />
		<jar compress="true" destfile="release/eadventure/eadventure-editor.jar">
			<fileset dir="release/">
				<include name="es/eucm/eadventure/editor/*.class" />
				<include name="es/eucm/eadventure/editor/**/*.class" />
			</fileset>
			<manifest>
				<attribute name="Main-Class" value="es.eucm.eadventure.editor.AdventureEditor" />
				<attribute name="Class-Path" value="${lib.project.manifest.classpath} jars/eadventure-common.jar eadventure-engine.jar jars/eadventure-comm-jar" />
			</manifest>
		</jar>
	</target>

	<target name="jar-comm" description="generate the comm jar" depends="complie">
		<delete file="release/eadventure/jars/eadventure-comm.jar" />
		<jar compress="true" destfile="release/eadventure/jars/eadventure-comm.jar">
			<fileset dir="release/">
				<include name="es/eucm/eadventure/comm/*.class" />
				<include name="es/eucm/eadventure/comm/**/*.class" />
			</fileset>
		</jar>
	</target>

	<target name="jar-common" description="generate the common jar" depends="complie">
		<delete file="release/eadventure/jars/eadventure-common.jar" />
		<jar compress="true" destfile="release/eadventure/jars/eadventure-common.jar">
			<fileset dir="release/">
				<include name="es/eucm/eadventure/common/*.class" />
				<include name="es/eucm/eadventure/common/**/*.class" />
			</fileset>
		</jar>
	</target>

	<target name="clear-all" description="clear all the generated files">
		<delete>
			<fileset dir="${basedir}/release">
				<include name="es/**/*.*" />
				<include name="eadventure/**/*.*" />
			</fileset>
		</delete>
	</target>

	<target name="copy-files" description="copy the necessary files">
		<copy todir="${basedir}/release/eadventure/jars" flatten="true">
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure/gui" flatten="false">
			<fileset dir="${gui.dir}">
				<include name="**/*.*" />
				<exclude name=".svn*/**" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure/img" flatten="false">
			<fileset dir="${img.dir}">
				<include name="**/*.*" />
				<exclude name=".svn*/**" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure/web" flatten="true">
			<fileset dir="${web.dir}">
				<include name="eAdventure_temp.jar" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure/i18n/engine" flatten="true">
			<fileset dir="${lanengine.dir}">
				<exclude name=".snv/**" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure/i18n/editor" flatten="true">
			<fileset dir="${laneditor.dir}">
				<exclude name=".snv/**" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure" flatten="true">
			<fileset dir="${basedir}">
				<include name="*.dtd" />
			</fileset>
		</copy>
		<copy todir="${basedir}/release/eadventure" flatten="true">
			<fileset dir="${basedir}/release">
				<include name="*.xml" />
			</fileset>
		</copy>

	</target>

	<target name="create-zip" description="creates the release zip">
		<delete>
			<fileset dir="${basedir}/release">
				<include name="es/**/*.*" />
			</fileset>
		</delete>
		<zip destfile="${basedir}/release/eAdventure-v${release.version}-multiplatform-nodoc.zip">
			<zipfileset dir="${basedir}/release">
				<exclude name="*.zip" />
				<exclude name="es*/**" />
				<exclude name="*.xml" />
			</zipfileset>
		</zip>
		<delete>
			<fileset dir="${basedir}/release">
				<include name="eadventure/**/*.*" />
			</fileset>
		</delete>
	</target>

	<target name="cleanup">
		<delete>
			<fileset dir="${basedir}/release">
				<include name="es/**/*.*" />
				<include name="eadventure/**/*.*" />
			</fileset>
		</delete>
	</target>

	<target name="build" description="build a project release">
		<antcall target="clear-all" />
		<ant antfile="create-applet.xml" target="generate" />
		<mkdir dir="release/eadventure" />
		<mkdir dir="release/eadventure/jars" />
		<antcall target="jar-engine" />
		<antcall target="jar-editor" />
		<antcall target="jar-comm" />
		<antcall target="jar-common" />
		<antcall target="copy-files" />
		<antcall target="create-zip" />
		<antcall target="cleanup" />
	</target>

</project>
